<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Produtos</title>
  <link rel="stylesheet" href="../../public/style.css">
  <style>

    .btn-deletar {
      background-color: #f44336;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;

    }

    .btn-deletar:hover {
      background-color: #da190b;
    }

    .btn-editar,
    .btn-salvar {
      background-color: #008CBA;

      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
    }

    .btn-editar:hover,
    .btn-salvar:hover {
      background-color: #007bb5;
    }

    .editable-field {
      border: 1px solid #ccc;
      padding: 4px;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <h1>Lista de Produtos</h1>
  <table>
    <thead>
      <tr>
        <th>Nome</th>
        <th>Quantidade</th>
        <th>Preço (R$)</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabela-produtos"></tbody>
  </table>
  <a href="../produtos/cadastro.html" class="link-basico">Cadastrar Produto</a>
  <a href="../../public/index.php" class="link-basico">Início</a>

  <script>

    function carregarProdutos() {
      fetch('../../controllers/ProdutoController.php')
        .then(res => res.json())
        .then(produtos => {
          const tabela = document.getElementById('tabela-produtos');
          tabela.innerHTML = '';

          produtos.forEach(p => {
            const linha = document.createElement('tr');
            linha.innerHTML = `
                            <td data-field="nome">${p.nome}</td>
                            <td data-field="quantidade">${p.quantidade}</td>
                            <td data-field="preco">${parseFloat(p.preco).toFixed(2)}</td>
                            <td>
                                <button class="btn-editar" data-id="${p.id}">Editar</button>
                                <button class="btn-deletar" data-id="${p.id}">Deletar</button>
                            </td>
                        `;
            tabela.appendChild(linha);
          });

          document.querySelectorAll('.btn-deletar').forEach(button => {
            button.addEventListener('click', function () {
              const produtoId = this.dataset.id;
              if (confirm(`Tem certeza que deseja deletar o produto com ID ${produtoId}?`)) {
                deletarProduto(produtoId);
              }
            });
          });

          document.querySelectorAll('.btn-editar').forEach(button => {
            button.addEventListener('click', function () {
              const produtoId = this.dataset.id;
              habilitarEdicao(this.closest('tr'), produtoId);
            });
          });
        })
        .catch(() => {
          alert('Erro ao carregar produtos.');
        });
    }

    function habilitarEdicao(linha, id) {
      const nomeCell = linha.querySelector('[data-field="nome"]');
      const quantidadeCell = linha.querySelector('[data-field="quantidade"]');
      const precoCell = linha.querySelector('[data-field="preco"]');
      const acoesCell = linha.querySelector('td:last-child');

      const nomeAtual = nomeCell.innerText;
      const quantidadeAtual = quantidadeCell.innerText;
      const precoAtual = precoCell.innerText;

      nomeCell.innerHTML = `<input type="text" class="editable-field" value="${nomeAtual}">`;
      quantidadeCell.innerHTML = `<input type="number" class="editable-field" value="${quantidadeAtual}">`;
      precoCell.innerHTML = `<input type="number" step="0.01" class="editable-field" value="${precoAtual.replace(',', '.')}">`;

      acoesCell.querySelector('.btn-editar').remove();
      const btnSalvar = document.createElement('button');
      btnSalvar.classList.add('btn-salvar');
      btnSalvar.innerText = 'Salvar';
      btnSalvar.dataset.id = id;
      acoesCell.prepend(btnSalvar);
      btnSalvar.addEventListener('click', function () {
        const novoNome = nomeCell.querySelector('input').value;
        const novaQuantidade = quantidadeCell.querySelector('input').value;
        const novoPreco = precoCell.querySelector('input').value;

        atualizarProduto(id, novoNome, novaQuantidade, novoPreco);
      });
    }

    function atualizarProduto(id, nome, quantidade, preco) {
      fetch('../../controllers/ProdutoController.php', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          id: id,
          nome: nome,
          quantidade: quantidade,
          preco: preco
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.sucesso) {
            alert(data.mensagem);
            carregarProdutos();
          } else {
            alert(data.erro);
          }
        })
        .catch(() => {
          alert('Erro ao tentar atualizar o produto.');
        });
    }

    function deletarProduto(id) {
      fetch('../../controllers/ProdutoController.php', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id: id })
      })
        .then(res => res.json())
        .then(data => {
          if (data.sucesso) {
            alert(data.mensagem);
            carregarProdutos(); 
          } else {
            alert(data.erro);
          }
        })
        .catch(() => {
          alert('Erro ao tentar deletar o produto.');
        });
    }
    document.addEventListener('DOMContentLoaded', carregarProdutos);
  </script>
</body>
</html>